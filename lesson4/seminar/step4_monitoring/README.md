# –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ FastAPI + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç **—Ä–µ–∞–ª—å–Ω—ã–π FastAPI —Å–µ—Ä–≤–∏—Å** –∏–∑ —à–∞–≥–∞ 2 –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –µ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
step4_monitoring/
‚îú‚îÄ‚îÄ main.py                     # –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ FastAPI + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ monitoring_config.yaml  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–æ–≤
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api.py                  # FastAPI —Å–µ—Ä–≤–∏—Å (–∏–∑ step2)
‚îÇ   ‚îú‚îÄ‚îÄ model_service.py        # ONNX —Å–µ—Ä–≤–∏—Å (–∏–∑ step2)
‚îÇ   ‚îú‚îÄ‚îÄ service_monitor.py      # HTTP –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ logger.py              # –¶–≤–µ—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ models/                     # ONNX –º–æ–¥–µ–ª—å (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ step1)
‚îú‚îÄ‚îÄ test_images/               # –¢–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ step2)
‚îî‚îÄ‚îÄ logs/                      # –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è)
```

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üöÄ **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ FastAPI —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8000
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ HTTP –∫–ª–∏–µ–Ω—Ç
- Graceful shutdown –ø—Ä–∏ Ctrl+C

### üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**
- **Health checks** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- **Inference —Ç–µ—Å—Ç—ã** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- **P95 latency** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **Error rate** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
- **Quality assessment** –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–æ–¥–µ–ª–∏

### üé® **–¶–≤–µ—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- üü¢ **–ó–µ–ª–µ–Ω—ã–π** - –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (OK)
- üü° **–ñ–µ–ª—Ç—ã–π** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (WARNING)
- üî¥ **–ö—Ä–∞—Å–Ω—ã–π** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (CRITICAL)
- üìä **–°–≤–æ–¥–∫–∏** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### üö® **–£–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- Cooldown –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ consecutive failures

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
poetry install
poetry shell
```

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
# –ö–æ–ø–∏—Ä—É–µ–º ONNX –º–æ–¥–µ–ª—å –∏–∑ step1
cp ../step1_onnx_model/models/blip_model.onnx models/

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ step2
cp ../step2_fastapi_inference/test_images/img.jpg test_images/
```

### 3. –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
```bash
python main.py
```

## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

### Phase 1: –ó–∞–ø—É—Å–∫ FastAPI
```
üöÄ –ó–∞–ø—É—Å–∫ FastAPI —Å–µ—Ä–≤–∏—Å–∞...
üì° FastAPI –∑–∞–ø—É—â–µ–Ω —Å PID: 12345
‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞...
‚úÖ FastAPI —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ

üåê –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º:
   ‚Ä¢ API: http://localhost:8000
   ‚Ä¢ Health: http://localhost:8000/health
   ‚Ä¢ Docs: http://localhost:8000/docs
```

### Phase 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```
üìä –ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê
üîç –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...
‚úÖ Test 1/5: 3842.1ms
‚úÖ Test 2/5: 3791.6ms
üìà P95 response time: 3850.23 ms [OK]
üìà Error rate: 0.00 % [OK]

üìä PERFORMANCE SUMMARY
Total tests: 5
Success rate: 100.0%
P95 response time: 3850.2ms
Latest prediction: 'a man fishing on a boat at sunset'
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### üéØ **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**
- **P95 Response Time** - 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- **Error Rate** - –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Health Status** - —Å—Ç–∞—Ç—É—Å health endpoint
- **Consecutive Failures** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫

### üé® **–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: `["man", "fishing", "boat", "sunset"]`
- **Quality Score** - –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
- **Latest Prediction** - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏

### ‚è±Ô∏è **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- **Inference Time** - –≤—Ä–µ–º—è ONNX –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞
- **Total Response Time** - –ø–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è HTTP –∑–∞–ø—Ä–æ—Å–∞
- **Request Throughput** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤

```yaml
thresholds:
  p95_latency_ms:
    warning: 4000   # 4 —Å–µ–∫—É–Ω–¥—ã
    critical: 8000  # 8 —Å–µ–∫—É–Ω–¥
  error_rate_percent:
    warning: 10     # 10% –æ—à–∏–±–æ–∫
    critical: 25    # 25% –æ—à–∏–±–æ–∫
  consecutive_failures:
    warning: 3      # 3 –ø–æ–¥—Ä—è–¥
    critical: 5     # 5 –ø–æ–¥—Ä—è–¥
```

## –ü—Ä–∏–º–µ—Ä—ã –∞–ª–µ—Ä—Ç–æ–≤

### ‚ö†Ô∏è Warning –∞–ª–µ—Ä—Ç—ã
```
üö® ALERT: p95_latency = 4200.5ms (Warning threshold exceeded)
‚ö†Ô∏è 3 consecutive failures detected
```

### üö® Critical –∞–ª–µ—Ä—Ç—ã
```
üö®üö® CRITICAL ALERT: error_rate = 30.0% (Critical threshold exceeded)
üö® 5 consecutive failures detected!
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üìÅ **–§–∞–π–ª—ã –ª–æ–≥–æ–≤**
- `logs/service_monitoring.log` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
- `logs/service_metrics.jsonl` - –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON Lines —Ñ–æ—Ä–º–∞—Ç–µ

### üìä **–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
```
üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
–¶–∏–∫–ª–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: 25
–°—Ä–µ–¥–Ω—è—è P95 response time: 3847.2 ms
–°—Ä–µ–¥–Ω–∏–π error rate: 2.1%
–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å: healthy
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: 'a man fishing on a boat at sunset'
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π restart** —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- ‚úÖ **Structured logging** –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
- ‚úÖ **Configurable thresholds** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥
- ‚úÖ **Real-time alerting** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:
- –û—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ –≤ Slack/Telegram
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Prometheus/Grafana
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –º–æ–¥–µ–ª–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ drift –º–æ–¥–µ–ª–∏

---

**üéØ –ò—Ç–æ–≥**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ production-ready FastAPI —Å–µ—Ä–≤–∏—Å–∞ —Å ONNX –º–æ–¥–µ–ª—å—é!
